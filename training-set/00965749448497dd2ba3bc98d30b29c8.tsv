FireEye	NNP	O
Labs	NNP	O
recently	RB	O
identified	VBD	O
several	JJ	O
widespread	JJ	O
malspam	NN	TECHNIQUE
(	(	O
malware	JJ	TECHNIQUE
spam	NN	TECHNIQUE
)	)	O
campaigns	VBZ	O
targeting	VBG	O
Brazilian	JJ	LOCATION
companies	NNS	O
with	IN	O
the	DT	O
goal	NN	O
of	IN	O
delivering	VBG	O
banking	NN	O
Trojans	NNPS	O
.	.	O
We	PRP	O
are	VBP	O
referring	VBG	O
to	TO	O
these	DT	O
campaigns	NNS	O
as	IN	O
Metamorfo	NNP	ACTOR
.	.	O
Across	IN	O
the	DT	O
stages	NNS	O
of	IN	O
these	DT	O
campaigns	NNS	O
,	,	O
we	PRP	O
have	VBP	O
observed	VBN	O
the	DT	O
use	NN	O
of	IN	O
several	JJ	O
tactics	NNS	O
and	CC	O
techniques	NNS	O
to	TO	O
evade	VB	TECHNIQUE
detection	NN	TECHNIQUE
and	CC	O
deliver	VB	O
the	DT	O
malicious	JJ	O
payload	NN	O
.	.	O
In	IN	O
this	DT	O
blog	NN	O
post	NN	O
we	PRP	O
dissect	VBP	O
two	CD	O
of	IN	O
the	DT	O
main	JJ	O
campaigns	NNS	O
and	CC	O
explain	VB	O
how	WRB	O
they	PRP	O
work	VBP	O
.	.	O
Campaign	NNP	O
#	#	O
1	CD	O
The	DT	O
kill	NN	O
chain	NN	O
starts	VBZ	O
with	IN	O
an	DT	O
email	NN	O
containing	VBG	O
an	DT	O
HTML	NNP	O
attachment	NN	O
with	IN	O
a	DT	O
refresh	JJ	O
tag	NN	O
that	WDT	O
uses	VBZ	O
a	DT	O
Google	NNP	TOOL
URL	NNP	TOOL
shortener	NN	TOOL
as	IN	O
the	DT	O
target	NN	O
.	.	O
Figure	NN	O
1	CD	O
shows	VBZ	O
a	DT	O
sample	JJ	O
email	NN	O
,	,	O
and	CC	O
Figure	NNP	O
2	CD	O
show	NN	O
the	DT	O
contents	NNS	O
of	IN	O
the	DT	O
HTML	NNP	O
file	NN	O
.	.	O
When	WRB	O
the	DT	O
URL	NNP	O
is	VBZ	O
loaded	VBN	O
,	,	O
it	PRP	O
redirects	VBZ	O
the	DT	O
victim	NN	O
to	TO	O
a	DT	O
cloud	JJ	O
storage	NN	O
site	NN	O
such	JJ	O
as	IN	O
GitHub	NNP	O
,	,	O
Dropbox	NNP	O
,	,	O
or	CC	O
Google	NNP	O
Drive	NNP	O
to	TO	O
download	VB	O
a	DT	O
ZIP	NNP	O
file	NN	O
.	.	O
An	DT	O
example	NN	O
is	VBZ	O
shown	VBN	O
in	IN	O
Figure	NNP	O
3	CD	O
.	.	O
The	DT	O
ZIP	NNP	O
archive	NN	O
contains	VBZ	O
a	DT	O
malicious	JJ	O
portable	JJ	TECHNIQUE
executable	JJ	TECHNIQUE
(	(	O
PE	NNP	O
)	)	O
file	NN	O
with	IN	O
embedded	JJ	O
HTML	NNP	O
application	NN	O
(	(	O
HTA	NNP	TOOL
)	)	O
.	.	O
The	DT	O
user	NN	O
has	VBZ	O
to	TO	O
unzip	VB	O
the	DT	O
archive	JJ	O
and	CC	O
double	JJ	O
-	:	O
click	NN	O
the	DT	O
executable	JJ	O
for	IN	O
the	DT	O
infection	NN	O
chain	NN	O
to	TO	O
continue	VB	O
.	.	O
The	DT	O
PE	NNP	O
file	NN	O
is	VBZ	O
a	DT	O
simple	JJ	O
HTA	NNP	TOOL
script	NN	O
compiled	VBD	O
into	IN	O
an	DT	O
executable	JJ	O
.	.	O
When	WRB	O
the	DT	O
user	NN	O
double	JJ	O
-	:	O
clicks	VBZ	O
the	DT	O
executable	JJ	O
,	,	O
the	DT	O
malicious	JJ	O
HTA	NNP	TOOL
file	NN	O
is	VBZ	O
extracted	VBN	O
to	TO	O
%	NN	O
temp%	NN	O
and	CC	O
executed	VBN	O
by	IN	O
mshta.exe	NN	TOOL
.	.	O
The	DT	O
HTA	NNP	TOOL
script	NN	O
(	(	O
Figure	NNP	O
4	CD	O
)	)	O
contains	NNS	O
VBS	NNP	TOOL
code	NN	O
that	WDT	O
fetches	VBZ	O
a	DT	O
second	JJ	O
blob	NN	O
of	IN	O
VBS	NNP	TOOL
code	NN	O
encoded	VBD	O
in	IN	O
base64	JJ	O
form	NN	O
from	IN	O
hxxp:///ilha	JJ	O
/	NNP	O
pz	NN	O
/	NNP	O
logs.php	NN	O
.	.	O
After	IN	O
the	DT	O
second	JJ	O
stage	NN	O
of	IN	O
VBS	NNP	TOOL
is	VBZ	O
decoded	VBN	O
(	(	O
Figure	NNP	O
5	CD	O
and	CC	O
Figure	NNP	O
6	CD	O
)	)	O
,	,	O
the	DT	O
script	NN	O
downloads	VBZ	O
the	DT	O
final	JJ	O
stage	NN	O
from	IN	O
hxxp:///28022018/pz.zip	NN	O
.	.	O
The	DT	O
downloaded	JJ	O
ZIP	NNP	O
file	NN	O
contains	VBZ	O
four	CD	O
files	NNS	O
.	.	O
Two	CD	O
are	VBP	O
PE	JJ	O
files	NNS	O
.	.	O
One	CD	O
is	VBZ	O
a	DT	O
legitimate	JJ	O
Windows	NNP	O
tool	NN	O
,	,	O
pvk2pfx.exe	NN	O
,	,	O
that	WDT	O
is	VBZ	O
abused	VBN	O
for	IN	O
DLL	NNP	TOOL
side	NN	O
-	:	O
loading	NN	O
.	.	O
One	CD	O
is	VBZ	O
the	DT	O
malicious	JJ	O
banking	NN	O
Trojan	NNP	TOOL
as	IN	O
the	DT	O
DLL	NNP	TOOL
.	.	O
The	DT	O
VBS	NNP	TOOL
code	NN	O
unzips	VBZ	O
the	DT	O
archive	JJ	O
,	,	O
changes	VBZ	O
the	DT	O
extension	NN	O
of	IN	O
the	DT	O
legitimate	JJ	O
Windows	NNP	O
tool	NN	O
from	IN	O
.png	NN	O
to	TO	O
.exe	VB	O
,	,	O
and	CC	O
renames	VBZ	O
the	DT	O
malicious	JJ	O
DLL	NNP	TOOL
as	IN	O
cryptui.dll	NN	TOOL
.	.	O
The	DT	O
VBS	NNP	TOOL
code	NN	O
also	RB	O
creates	VBZ	O
a	DT	O
file	NN	O
in	IN	O
C:\Users\Public\Administrador\car.dat	NNP	O
with	IN	O
random	JJ	O
strings	NNS	O
.	.	O
These	DT	O
random	JJ	O
strings	NNS	O
are	VBP	O
used	VBN	O
to	TO	O
name	VB	O
the	DT	O
Windows	NNP	O
tool	NN	O
,	,	O
which	WDT	O
is	VBZ	O
then	RB	O
executed	VBN	O
.	.	O
Since	IN	O
this	DT	O
tool	NN	O
depends	VBZ	O
on	IN	O
a	DT	O
legitimate	JJ	O
DLL	NNP	TOOL
named	VBD	O
cryptui.dll	NN	TOOL
,	,	O
the	DT	O
search	NN	O
order	NN	O
path	NN	O
will	MD	O
find	VB	O
the	DT	O
malicious	JJ	O
Trojan	NNP	TOOL
with	IN	O
the	DT	O
same	JJ	O
name	NN	O
in	IN	O
the	DT	O
same	JJ	O
directory	NN	O
and	CC	O
load	NN	O
it	PRP	O
into	IN	O
its	PRP$	O
process	NN	O
space	NN	O
.	.	O
In	IN	O
Q4	NNP	O
of	IN	O
2017	CD	O
,	,	O
a	DT	O
similar	JJ	O
malspam	NN	TECHNIQUE
campaign	NN	O
delivered	VBD	O
the	DT	O
same	JJ	O
banking	NN	O
Trojan	NNP	TOOL
by	IN	O
using	VBG	O
an	DT	O
embedded	JJ	O
JAR	NNP	O
file	NN	O
attached	VBN	O
in	IN	O
the	DT	O
email	NN	O
instead	RB	O
of	IN	O
an	DT	O
HTML	NNP	O
attachment	NN	O
.	.	O
On	IN	O
execution	NN	O
,	,	O
the	DT	O
Java	NNP	O
code	NN	O
downloaded	VBD	O
a	DT	O
ZIP	NNP	O
archive	NN	O
from	IN	O
a	DT	O
cloud	NN	O
file	NN	O
hosting	VBG	O
site	NN	O
such	JJ	O
as	IN	O
Google	NNP	O
Drive	NNP	O
,	,	O
Dropbox	NNP	O
,	,	O
or	CC	O
Github	NNP	O
.	.	O
The	DT	O
ZIP	NNP	O
archive	NN	O
contained	VBD	O
a	DT	O
legitimate	JJ	O
Microsoft	NNP	O
tool	NN	O
and	CC	O
the	DT	O
malicious	JJ	O
Trojan	NNP	TOOL
.	.	O
Banking	VBG	O
Trojan	NNP	TOOL
Analysis	NN	O
The	DT	O
Trojan	NNP	TOOL
expects	VBZ	O
to	TO	O
be	VB	O
located	VBN	O
in	IN	O
the	DT	O
hardcoded	JJ	O
directory	NN	O
C:\\Users\\Public\Administrador\\	NNP	O
along	IN	O
with	IN	O
three	CD	O
other	JJ	O
files	NNS	O
to	TO	O
start	VB	O
execution	NN	O
.	.	O
As	IN	O
seen	VBN	O
in	IN	O
Figure	NNP	O
7	CD	O
,	,	O
these	DT	O
files	NNS	O
are	VBP	O
:	:	O
car.dat	NN	O
(	(	O
randomly	RB	O
generated	VBN	O
name	NN	O
given	VBN	O
to	TO	O
Windows	NNP	O
tool	NN	O
)	)	O
i4.dt	NN	O
(	(	O
VBS	NNP	TOOL
script	NN	O
that	WDT	O
downloads	VBZ	O
the	DT	O
same	JJ	O
zip	NNP	O
file	NN	O
)	)	O
i	NN	O
d	NN	O
(	(	O
ID	NNP	O
given	VBN	O
to	TO	O
host	VB	O
)	)	O
cryptui.dll	NN	TOOL
(	(	O
malicious	JJ	O
Trojan	NNP	TOOL
)	)	O
Persistence	NN	O
The	DT	O
string	NN	O
found	VBN	O
in	IN	O
the	DT	O
file	NN	O
C:\\Users\\Public\\Administrador\\car.dat	NNP	O
is	VBZ	O
extracted	VBN	O
and	CC	O
used	VBN	O
to	TO	O
add	VB	TECHNIQUE
the	DT	TECHNIQUE
registry	NN	TECHNIQUE
key	JJ	TECHNIQUE
Software\Microsoft\Windows\CurrentVersion\Run\	NNP	O
for	IN	O
persistence	NN	O
.	.	O
The	DT	O
sample	NN	O
also	RB	O
looks	VBZ	O
for	IN	O
a	DT	O
file	NN	O
named	VBN	O
i4.dt	NN	O
in	IN	O
the	DT	O
same	JJ	O
directory	NN	O
and	CC	O
extracts	VBZ	O
the	DT	O
contents	NNS	O
of	IN	O
it	PRP	O
,	,	O
renames	VBZ	O
the	DT	O
file	NN	O
to	TO	O
icone.vbs	VB	O
,	,	O
and	CC	O
creates	VBZ	O
a	DT	O
new	JJ	O
persistent	NN	O
key	NN	O
(	(	O
Figure	NNP	O
9	CD	O
)	)	O
in	IN	O
\Software\Microsoft\Windows\CurrentVersion\Run	NN	O
to	TO	O
open	VB	O
this	DT	O
file	NN	O
.	.	O
Command	NNP	O
and	CC	O
Control	NNP	O
The	DT	O
command	NN	TECHNIQUE
and	CC	TECHNIQUE
control	NN	TECHNIQUE
(	(	O
C2	NNP	O
)	)	O
server	NN	O
is	VBZ	O
selected	VBN	O
based	VBN	O
on	IN	O
the	DT	O
string	NN	O
in	IN	O
the	DT	O
file	NN	O
"	NN	O
i	NN	O
d	VBP	O
"	NN	O
:	:	O
al	JJ	O
-	:	O
>	NN	O
'	POS	O
185.43.209[.]182	CD	O
'	POS	O
gr	NN	O
-	:	O
>	NN	O
'	''	O
212.237.46[.]6	CD	O
'	POS	O
pz	NN	O
-	:	O
>	NN	O
'	''	O
87.98.146[.]34	CD	O
'	POS	O
mn	NN	O
-	:	O
>	NN	O
'	''	O
80.211.140[.]235	CD	O
'	''	O
The	DT	O
connection	NN	O
to	TO	O
one	CD	O
of	IN	O
the	DT	O
hosts	NNS	O
is	VBZ	O
then	RB	O
started	VBN	O
over	IN	O
raw	JJ	O
TCP	NNP	O
on	IN	O
port	NN	O
9999	CD	O
.	.	O
The	DT	O
command	NN	TECHNIQUE
and	CC	TECHNIQUE
control	NN	TECHNIQUE
communication	NN	O
generally	RB	O
follows	VBZ	O
the	DT	O
pattern	NN	O
<	NNP	O
|Command	NNP	O
|	NNP	O
>	NNP	O
,	,	O
for	IN	O
example	NN	O
:	:	O
'	POS	O
<	JJ	O
|dispida|>logs	NNS	O
>	VBP	O
SAVE	NNP	O
<	NNP	O
'	POS	O
sends	VBZ	O
the	DT	O
screenshots	NNS	O
collected	VBN	O
in	IN	O
gh.txt	NN	O
.	.	O
''	''	O
is	VBZ	O
sent	VBN	O
from	IN	O
C2	NNP	O
to	TO	O
host	VB	O
,	,	O
and	CC	O
''	''	O
is	VBZ	O
sent	VBN	O
from	IN	O
host	NN	O
to	TO	O
C2	NNP	O
,	,	O
to	TO	O
keep	VB	O
the	DT	O
connection	NN	O
alive	JJ	O
.	.	O
'	''	O
<	JJ	O
|INFO|	NNP	O
>	NNP	O
'	POS	O
retrieves	NNS	O
when	WRB	O
the	DT	O
infection	NN	O
first	RB	O
started	VBD	O
based	VBN	O
on	IN	O
the	DT	O
file	NN	O
timestamp	NN	O
from	IN	O
car.dat	NN	O
along	IN	O
with	IN	O
'	POS	O
<	NNS	O
|	VBP	O
>	NNP	O
'	POS	O
and	CC	O
the	DT	O
host	NN	O
information	NN	O
.	.	O
